<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - DSP UI Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', system-ui, sans-serif; margin: 0; }
        .editor-font { font-family: 'JetBrains Mono', 'Consolas', monospace; }
        .config-card { transition: all 0.2s; }
        .manifest-card { transition: all 0.2s; }
        .config-card:hover { border-color: #3b82f6; }
        .manifest-card:hover { border-color: #22c55e; }
        .toast { animation: slideIn 0.3s ease-out, fadeOut 0.3s ease-in 2.7s; }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .editor-area { tab-size: 2; line-height: 1.6; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .status-file { background: #22c55e; }
        .status-dynamic { background: #f59e0b; }
        .status-invalid { background: #ef4444; }
        .tab-btn-active { background: #1d4ed8; color: #ffffff; }
        .tab-btn-inactive { color: #94a3b8; }
        .tab-btn-inactive:hover { color: #e2e8f0; }

        /* Collapsible JSON tree view */
        #json-tree { font-family: 'JetBrains Mono', 'Consolas', monospace; font-size: 0.8rem; line-height: 1.45; }
        #json-tree details { margin-left: 10px; padding-left: 8px; border-left: 1px dashed #334155; }
        #json-tree summary { cursor: pointer; list-style: none; display: flex; align-items: center; gap: 6px; }
        #json-tree summary::-webkit-details-marker { display: none; }
        #json-tree summary::before { content: '▸'; color: #94a3b8; transition: transform 0.15s ease; }
        #json-tree details[open] > summary::before { transform: rotate(90deg); }
        #json-tree .json-key { color: #93c5fd; }
        #json-tree .json-struct { color: #f59e0b; }
        #json-tree .json-meta { color: #94a3b8; font-size: 0.72rem; }
        #json-tree .json-leaf { margin-left: 18px; padding: 1px 0; }
        #json-tree .json-str { color: #86efac; }
        #json-tree .json-num { color: #fca5a5; }
        #json-tree .json-bool { color: #c4b5fd; }
        #json-tree .json-null { color: #94a3b8; font-style: italic; }
    </style>
</head>
<body class="min-h-screen bg-slate-900 text-white">
    <!-- Toast container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div>

    <!-- Header -->
    <header class="border-b border-slate-700 bg-slate-800/80 backdrop-blur sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-6 h-14 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <a href="/" class="text-slate-400 hover:text-white transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                    </svg>
                </a>
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    <h1 class="font-semibold text-sm">Config Admin</h1>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <span id="config-count" class="text-xs text-slate-400"></span>
                <button onclick="reloadAll()"
                        class="text-xs px-3 py-1.5 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-medium transition-colors flex items-center gap-1.5">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Reload All
                </button>
                <button onclick="showNewConfigModal()"
                        class="text-xs px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white font-medium transition-colors flex items-center gap-1.5">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    New Config
                </button>
                <a href="/admin/logout"
                   class="text-xs px-3 py-1.5 rounded-lg bg-slate-700 hover:bg-slate-600 text-slate-300 font-medium transition-colors flex items-center gap-1.5">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                    </svg>
                    Logout
                </a>
            </div>
        </div>
    </header>

    <!-- Main layout: sidebar + editor -->
    <div class="max-w-7xl mx-auto flex" style="height: calc(100vh - 56px);">
        <!-- Sidebar: config + manifest lists -->
        <aside id="sidebar" class="w-72 flex-shrink-0 border-r border-slate-700 overflow-y-auto p-4">
            <div class="mb-3 rounded-lg bg-slate-800 p-1 flex items-center gap-1">
                <button id="tab-configs" onclick="switchSidebarTab('configs')"
                        class="flex-1 text-xs px-2 py-1.5 rounded-md font-medium tab-btn-active">
                    UI Configs
                </button>
                <button id="tab-manifests" onclick="switchSidebarTab('manifests')"
                        class="flex-1 text-xs px-2 py-1.5 rounded-md font-medium tab-btn-inactive">
                    CT Manifests
                </button>
            </div>

            <div id="configs-list" class="space-y-2">
                {% for slug, cfg in configs.items() %}
                <div class="config-card rounded-lg border border-slate-700 bg-slate-800 p-3 cursor-pointer"
                     data-slug="{{ slug }}" onclick="loadConfig(this.dataset.slug)">
                    <div class="flex items-center gap-2 mb-1">
                        <div class="status-dot status-file" title="File-based config"></div>
                        <span class="font-medium text-sm truncate">{{ cfg.name }}</span>
                    </div>
                    <div class="flex items-center gap-2 text-xs text-slate-400">
                        <span class="px-1.5 py-0.5 rounded bg-slate-700">{{ slug }}</span>
                        <span>{{ cfg.chat.endpoints|length }} ep</span>
                        <span>{{ cfg.auth.type }}</span>
                    </div>
                </div>
                {% endfor %}
                {% if not configs %}
                <div class="text-center text-slate-500 text-sm py-8">No configs loaded</div>
                {% endif %}
            </div>

            <div id="manifests-list" class="hidden space-y-2">
                <div class="text-[11px] text-slate-500 px-1 pb-1 break-all">
                    {% if ct_manifest_dir %}
                    {{ ct_manifest_dir }}
                    {% else %}
                    CT_MANIFESTS_DIR is not configured in .env
                    {% endif %}
                </div>
                {% for manifest in manifests %}
                <div class="manifest-card rounded-lg border border-slate-700 bg-slate-800 p-3 cursor-pointer"
                     data-manifest="{{ manifest.name }}" onclick="loadManifest(this.dataset.manifest)">
                    <div class="flex items-center gap-2 mb-1">
                        <div class="status-dot {% if manifest.valid %}status-file{% else %}status-invalid{% endif %}"
                             title="{% if manifest.valid %}Valid manifest{% else %}Invalid JSON{% endif %}"></div>
                        <span class="manifest-title font-medium text-sm truncate">{{ manifest.title }}</span>
                    </div>
                    <div class="flex flex-wrap items-center gap-2 text-xs text-slate-400">
                        <span class="px-1.5 py-0.5 rounded bg-slate-700">{{ manifest.file_name }}</span>
                        {% if manifest.modules is not none %}
                        <span>{{ manifest.modules }} mod</span>
                        {% endif %}
                        {% if manifest.environment %}
                        <span>{{ manifest.environment }}</span>
                        {% endif %}
                        {% if not manifest.valid %}
                        <span class="text-red-400">invalid json</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                {% if not manifests %}
                <div class="text-center text-slate-500 text-sm py-8">No manifests found</div>
                {% endif %}
            </div>
        </aside>

        <!-- Editor panel -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <!-- Editor toolbar -->
            <div id="editor-toolbar" class="hidden flex-shrink-0 border-b border-slate-700 bg-slate-800/50 px-4 py-2 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span id="editor-slug" class="text-sm font-medium text-blue-400"></span>
                    <span id="editor-source" class="text-xs px-2 py-0.5 rounded-full bg-slate-700 text-slate-400"></span>
                    <span id="editor-dirty" class="hidden text-xs text-amber-400 font-medium">● unsaved</span>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="saveConfig()"
                            class="text-xs px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white font-medium transition-colors flex items-center gap-1.5">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/>
                        </svg>
                        Save
                    </button>
                    <button id="toggle-tree-btn" onclick="toggleTreeView()"
                            class="hidden text-xs px-3 py-1.5 rounded-lg bg-violet-600 hover:bg-violet-500 text-white font-medium transition-colors">
                        Tree View
                    </button>
                    <button id="open-chat-btn" onclick="openInChat()"
                            class="text-xs px-3 py-1.5 rounded-lg bg-slate-600 hover:bg-slate-500 text-white font-medium transition-colors">
                        Open Chat
                    </button>
                    <button id="delete-btn" onclick="deleteConfig()"
                            class="text-xs px-3 py-1.5 rounded-lg bg-red-700 hover:bg-red-600 text-white font-medium transition-colors">
                        Delete
                    </button>
                </div>
            </div>

            <!-- Editor area -->
            <div id="editor-area" class="flex-1 overflow-hidden flex flex-col">
                <!-- Placeholder when no config selected -->
                <div id="editor-placeholder" class="flex-1 flex items-center justify-center text-slate-500">
                    <div class="text-center">
                        <svg class="w-12 h-12 mx-auto mb-3 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <p class="text-sm">Select a UI config or CT manifest from the sidebar</p>
                        <p class="text-xs mt-1">then edit raw content or view manifests as a collapsible tree</p>
                    </div>
                </div>

                <!-- YAML editor -->
                <textarea id="yaml-editor"
                          class="hidden flex-1 w-full bg-slate-950 text-slate-200 editor-font editor-area p-4 resize-none focus:outline-none border-none text-sm"
                          spellcheck="false"
                          wrap="off"></textarea>

                <!-- Collapsible JSON tree for manifests -->
                <div id="json-tree-panel" class="hidden flex-1 overflow-auto bg-slate-950 p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="text-xs text-slate-400">Collapsible Manifest View</div>
                        <div class="flex items-center gap-2">
                            <button onclick="expandJsonTree()" class="text-xs px-2 py-1 rounded bg-slate-700 hover:bg-slate-600 text-slate-200">Expand all</button>
                            <button onclick="collapseJsonTree()" class="text-xs px-2 py-1 rounded bg-slate-700 hover:bg-slate-600 text-slate-200">Collapse all</button>
                        </div>
                    </div>
                    <div id="json-tree"></div>
                </div>

                <!-- Validation status -->
                <div id="validation-bar" class="hidden flex-shrink-0 border-t border-slate-700 bg-slate-800/50 px-4 py-2 flex items-center gap-2">
                    <span id="validation-icon"></span>
                    <span id="validation-msg" class="text-xs"></span>
                </div>
            </div>
        </main>
    </div>

    <!-- New config modal -->
    <div id="new-config-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-slate-800 border border-slate-600 rounded-2xl shadow-2xl w-full max-w-md p-6">
            <h2 class="text-lg font-semibold mb-4">New Configuration</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-medium text-slate-400 mb-1">Slug (filename)</label>
                    <input id="new-slug" type="text" placeholder="my-chatbot"
                           class="w-full px-3 py-2 rounded-lg bg-slate-700 border border-slate-600 text-sm text-white focus:outline-none focus:border-blue-500"
                           pattern="[a-z0-9\-]+" title="Lowercase letters, numbers, and hyphens only">
                </div>
                <div>
                    <label class="block text-xs font-medium text-slate-400 mb-1">Display Name</label>
                    <input id="new-name" type="text" placeholder="My Chatbot"
                           class="w-full px-3 py-2 rounded-lg bg-slate-700 border border-slate-600 text-sm text-white focus:outline-none focus:border-blue-500">
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="hideNewConfigModal()" class="text-xs px-4 py-2 rounded-lg bg-slate-600 hover:bg-slate-500 text-white transition-colors">Cancel</button>
                <button onclick="createNewConfig()" class="text-xs px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white font-medium transition-colors">Create</button>
            </div>
        </div>
    </div>

<script>
let currentType = null; // config | manifest
let currentId = null;
let currentFormat = 'yaml'; // yaml | json
let originalContent = '';
let treeViewEnabled = false;

const editor = document.getElementById('yaml-editor');
const placeholder = document.getElementById('editor-placeholder');
const toolbar = document.getElementById('editor-toolbar');
const validationBar = document.getElementById('validation-bar');
const openChatBtn = document.getElementById('open-chat-btn');
const toggleTreeBtn = document.getElementById('toggle-tree-btn');
const jsonTreePanel = document.getElementById('json-tree-panel');
const jsonTreeRoot = document.getElementById('json-tree');

function findCard(attrName, value) {
    return Array.from(document.querySelectorAll(`[${attrName}]`)).find((el) => el.getAttribute(attrName) === value) || null;
}

function updateCount() {
    const cfgCount = document.querySelectorAll('.config-card').length;
    const manifestCount = document.querySelectorAll('.manifest-card').length;
    document.getElementById('config-count').textContent = `${cfgCount} configs • ${manifestCount} manifests`;
}

function switchSidebarTab(tab) {
    const cfgBtn = document.getElementById('tab-configs');
    const mfBtn = document.getElementById('tab-manifests');
    const cfgList = document.getElementById('configs-list');
    const mfList = document.getElementById('manifests-list');

    const showConfigs = tab === 'configs';

    cfgBtn.classList.toggle('tab-btn-active', showConfigs);
    cfgBtn.classList.toggle('tab-btn-inactive', !showConfigs);
    mfBtn.classList.toggle('tab-btn-active', !showConfigs);
    mfBtn.classList.toggle('tab-btn-inactive', showConfigs);

    cfgList.classList.toggle('hidden', !showConfigs);
    mfList.classList.toggle('hidden', showConfigs);
}

function clearSelection() {
    document.querySelectorAll('.config-card, .manifest-card').forEach((card) => {
        card.classList.remove('ring-2', 'ring-blue-500', 'ring-emerald-500');
    });
}

function resetEditor() {
    currentType = null;
    currentId = null;
    currentFormat = 'yaml';
    originalContent = '';
    treeViewEnabled = false;

    editor.value = '';
    editor.classList.add('hidden');
    jsonTreePanel.classList.add('hidden');
    placeholder.classList.remove('hidden');

    toolbar.classList.add('hidden');
    toolbar.classList.remove('flex');
    validationBar.classList.add('hidden');
    validationBar.classList.remove('flex');

    toggleTreeBtn.classList.add('hidden');
    openChatBtn.classList.remove('hidden');
}

function applyEditorState(content, options) {
    currentType = options.type;
    currentId = options.id;
    currentFormat = options.format;
    originalContent = content;
    treeViewEnabled = false;

    editor.value = content;
    editor.classList.remove('hidden');
    jsonTreePanel.classList.add('hidden');
    placeholder.classList.add('hidden');
    toolbar.classList.remove('hidden');
    toolbar.classList.add('flex');
    validationBar.classList.remove('hidden');
    validationBar.classList.add('flex');

    document.getElementById('editor-slug').textContent = options.type === 'manifest' ? `manifest/${options.id}` : options.id;
    document.getElementById('editor-source').textContent = options.type === 'manifest' ? 'CT MANIFEST' : (options.source === 'file' ? 'FILE CONFIG' : 'DYNAMIC CONFIG');
    document.getElementById('editor-dirty').classList.add('hidden');

    openChatBtn.classList.toggle('hidden', options.type !== 'config');
    toggleTreeBtn.classList.toggle('hidden', options.type !== 'manifest');
    toggleTreeBtn.textContent = 'Tree View';

    validateContent();
}

async function loadConfig(slug) {
    clearSelection();
    const card = findCard('data-slug', slug);
    if (card) card.classList.add('ring-2', 'ring-blue-500');

    try {
        const resp = await fetch(`/admin/config/${encodeURIComponent(slug)}`);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        applyEditorState(data.yaml, { type: 'config', id: slug, source: data.source, format: 'yaml' });
    } catch (err) {
        showToast(`Failed to load config ${slug}: ${err.message}`, 'error');
    }
}

async function loadManifest(name) {
    clearSelection();
    switchSidebarTab('manifests');
    const card = findCard('data-manifest', name);
    if (card) card.classList.add('ring-2', 'ring-emerald-500');

    try {
        const resp = await fetch(`/admin/manifest/${encodeURIComponent(name)}`);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        applyEditorState(data.content, { type: 'manifest', id: name, source: data.source, format: 'json' });
    } catch (err) {
        showToast(`Failed to load manifest ${name}: ${err.message}`, 'error');
    }
}

editor.addEventListener('input', () => {
    const dirty = editor.value !== originalContent;
    document.getElementById('editor-dirty').classList.toggle('hidden', !dirty);
    validateContent();
    if (currentType === 'manifest' && treeViewEnabled) {
        renderJsonTree();
    }
});

function validateContent() {
    const icon = document.getElementById('validation-icon');
    const msg = document.getElementById('validation-msg');
    const content = editor.value;

    if (!content.trim()) {
        icon.textContent = '⚠';
        msg.textContent = 'Empty content';
        msg.className = 'text-xs text-amber-400';
        return false;
    }

    if (currentFormat === 'json') {
        try {
            JSON.parse(content);
            icon.textContent = '✓';
            msg.textContent = `Valid JSON • ${content.split('\n').length} lines`;
            msg.className = 'text-xs text-emerald-400';
            return true;
        } catch (err) {
            icon.textContent = '✗';
            msg.textContent = `JSON error: ${err.message}`;
            msg.className = 'text-xs text-red-400';
            return false;
        }
    }

    // YAML light-weight hints
    if (content.includes('\t')) {
        icon.textContent = '⚠';
        msg.textContent = 'Warning: tabs detected (YAML prefers spaces)';
        msg.className = 'text-xs text-amber-400';
        return true;
    }

    icon.textContent = '✓';
    msg.textContent = `${content.split('\n').length} lines`;
    msg.className = 'text-xs text-emerald-400';
    return true;
}

async function saveConfig() {
    if (!currentType || !currentId) return;

    if (!validateContent()) {
        showToast('Fix validation errors before saving', 'error');
        return;
    }

    try {
        const url = currentType === 'config'
            ? `/admin/config/${encodeURIComponent(currentId)}`
            : `/admin/manifest/${encodeURIComponent(currentId)}`;

        const body = currentType === 'config'
            ? { yaml: editor.value }
            : { content: editor.value };

        const resp = await fetch(url, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.detail || 'Save failed');

        originalContent = editor.value;
        document.getElementById('editor-dirty').classList.add('hidden');

        if (currentType === 'config') {
            showToast(`Saved config: ${data.name || currentId}`, 'success');
            const card = findCard('data-slug', currentId);
            if (card) {
                const nameEl = card.querySelector('.font-medium');
                if (nameEl && data.name) nameEl.textContent = data.name;
            }
        } else {
            showToast(`Saved manifest: ${data.title || currentId}`, 'success');
            const card = findCard('data-manifest', currentId);
            if (card) {
                const titleEl = card.querySelector('.manifest-title');
                if (titleEl && data.title) titleEl.textContent = data.title;
            }
            if (treeViewEnabled) renderJsonTree();
        }
    } catch (err) {
        showToast(`Save error: ${err.message}`, 'error');
    }
}

async function deleteConfig() {
    if (!currentType || !currentId) return;

    const noun = currentType === 'config' ? 'config' : 'manifest';
    if (!confirm(`Delete ${noun} "${currentId}"? This cannot be undone.`)) return;

    try {
        const url = currentType === 'config'
            ? `/admin/config/${encodeURIComponent(currentId)}/delete`
            : `/admin/manifest/${encodeURIComponent(currentId)}/delete`;

        const resp = await fetch(url, { method: 'POST' });
        if (!resp.ok) {
            let message = `Delete failed (HTTP ${resp.status})`;
            try {
                const data = await resp.json();
                message = data.detail || message;
            } catch (err) {
                // Ignore JSON parse error and use default message.
            }
            throw new Error(message);
        }

        const attr = currentType === 'config' ? 'data-slug' : 'data-manifest';
        const card = findCard(attr, currentId);
        if (card) card.remove();

        showToast(`${noun} deleted`, 'success');
        updateCount();
        resetEditor();
    } catch (err) {
        showToast(`Delete error: ${err.message}`, 'error');
    }
}

async function reloadAll() {
    try {
        const resp = await fetch('/admin/reload', { method: 'POST' });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.detail || 'Reload failed');
        showToast(`Reloaded ${data.configs.length} configs and ${data.manifests || 0} manifests`, 'success');
        setTimeout(() => location.reload(), 500);
    } catch (err) {
        showToast(`Reload error: ${err.message}`, 'error');
    }
}

function openInChat() {
    if (currentType === 'config' && currentId) {
        window.open(`/${currentId}/login`, '_blank');
    }
}

function makeValueSpan(value) {
    const span = document.createElement('span');
    if (typeof value === 'string') {
        span.className = 'json-str';
        span.textContent = JSON.stringify(value);
    } else if (typeof value === 'number') {
        span.className = 'json-num';
        span.textContent = String(value);
    } else if (typeof value === 'boolean') {
        span.className = 'json-bool';
        span.textContent = String(value);
    } else if (value === null) {
        span.className = 'json-null';
        span.textContent = 'null';
    } else {
        span.className = 'json-null';
        span.textContent = String(value);
    }
    return span;
}

function buildJsonNode(key, value, depth = 0, root = false) {
    if (value !== null && typeof value === 'object') {
        const details = document.createElement('details');
        if (root || depth < 2) details.open = true;

        const summary = document.createElement('summary');
        const keySpan = document.createElement('span');
        keySpan.className = 'json-key';
        keySpan.textContent = key;

        const typeSpan = document.createElement('span');
        typeSpan.className = 'json-struct';
        if (Array.isArray(value)) {
            typeSpan.textContent = '[ ]';
        } else {
            typeSpan.textContent = '{ }';
        }

        const metaSpan = document.createElement('span');
        metaSpan.className = 'json-meta';
        const size = Array.isArray(value) ? value.length : Object.keys(value).length;
        metaSpan.textContent = `${size} item${size === 1 ? '' : 's'}`;

        summary.appendChild(keySpan);
        summary.appendChild(typeSpan);
        summary.appendChild(metaSpan);
        details.appendChild(summary);

        if (Array.isArray(value)) {
            value.forEach((item, index) => {
                details.appendChild(buildJsonNode(`[${index}]`, item, depth + 1));
            });
        } else {
            Object.entries(value).forEach(([childKey, childValue]) => {
                details.appendChild(buildJsonNode(childKey, childValue, depth + 1));
            });
        }
        return details;
    }

    const leaf = document.createElement('div');
    leaf.className = 'json-leaf';

    const keySpan = document.createElement('span');
    keySpan.className = 'json-key';
    keySpan.textContent = key;

    leaf.appendChild(keySpan);
    leaf.appendChild(document.createTextNode(': '));
    leaf.appendChild(makeValueSpan(value));
    return leaf;
}

function renderJsonTree() {
    if (currentType !== 'manifest') return false;
    jsonTreeRoot.innerHTML = '';

    try {
        const parsed = JSON.parse(editor.value);
        jsonTreeRoot.appendChild(buildJsonNode('(root)', parsed, 0, true));
        return true;
    } catch (err) {
        const errEl = document.createElement('div');
        errEl.className = 'text-sm text-red-400';
        errEl.textContent = `Cannot render tree: ${err.message}`;
        jsonTreeRoot.appendChild(errEl);
        return false;
    }
}

function toggleTreeView() {
    if (currentType !== 'manifest') return;
    treeViewEnabled = !treeViewEnabled;

    if (treeViewEnabled) {
        if (!renderJsonTree()) {
            treeViewEnabled = false;
            showToast('Fix JSON before opening tree view', 'error');
            return;
        }
        editor.classList.add('hidden');
        jsonTreePanel.classList.remove('hidden');
        toggleTreeBtn.textContent = 'Editor View';
    } else {
        jsonTreePanel.classList.add('hidden');
        editor.classList.remove('hidden');
        toggleTreeBtn.textContent = 'Tree View';
    }
}

function expandJsonTree() {
    document.querySelectorAll('#json-tree details').forEach((el) => {
        el.open = true;
    });
}

function collapseJsonTree() {
    const nodes = Array.from(document.querySelectorAll('#json-tree details'));
    nodes.forEach((el, idx) => {
        el.open = idx === 0;
    });
}

function showNewConfigModal() {
    document.getElementById('new-config-modal').classList.remove('hidden');
}

function hideNewConfigModal() {
    document.getElementById('new-config-modal').classList.add('hidden');
}

const DEFAULT_YAML = `name: "My Chatbot"
description: "A new chatbot configuration"

theme:
  primary_color: "#2563eb"
  secondary_color: "#1e40af"
  accent_color: "#3b82f6"
  background_color: "#f8fafc"
  text_color: "#1e293b"

auth:
  type: "simple"
  session_duration_minutes: 480

chat:
  placeholder: "Type your message..."
  welcome_message: "Hello! How can I help you today?"
  input:
    type: "text"
    rows: 1
    max_rows: 6
    submit_on_enter: true
  endpoints:
    - name: "default"
      url: "http://localhost:8080/query"
      method: "POST"
      headers:
        Content-Type: "application/json"
        Authorization: "Bearer {{token}}"
      body_template:
        query: "{{message}}"
      response_field: "response"
`;

async function createNewConfig() {
    const slug = document.getElementById('new-slug').value.trim().replace(/[^a-z0-9\-]/g, '');
    const name = document.getElementById('new-name').value.trim() || 'My Chatbot';

    if (!slug) {
        showToast('Slug is required', 'error');
        return;
    }

    const yamlContent = DEFAULT_YAML.replace('name: "My Chatbot"', `name: "${name}"`);

    try {
        const resp = await fetch(`/admin/config/${encodeURIComponent(slug)}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ yaml: yamlContent }),
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.detail || 'Create failed');

        hideNewConfigModal();
        showToast(`Created config: ${name}`, 'success');
        setTimeout(() => location.reload(), 500);
    } catch (err) {
        showToast(`Create error: ${err.message}`, 'error');
    }
}

function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    const bg = type === 'success' ? 'bg-emerald-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600';
    toast.className = `toast ${bg} text-white text-sm px-4 py-2 rounded-lg shadow-lg`;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        saveConfig();
    }
});

updateCount();
switchSidebarTab('configs');
</script>
</body>
</html>
