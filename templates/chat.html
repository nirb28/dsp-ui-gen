{% extends "base.html" %}
{% block head %}
<style>
    #messages { scroll-behavior: smooth; }
    .msg-user { background: {{ cfg.theme.primary_color }}0d; border-left: 3px solid {{ cfg.theme.primary_color }}; }
    .msg-bot { background: #f1f5f9; border-left: 3px solid #94a3b8; }
    .typing-dot { animation: typing 1.4s infinite; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing { 0%,60%,100% { opacity: 0.3; } 30% { opacity: 1; } }
    textarea:focus { box-shadow: 0 0 0 3px {{ cfg.theme.primary_color }}33; }
    .msg-content { white-space: pre-wrap; word-wrap: break-word; }
    .msg-content p { margin-bottom: 0.5em; }
    .msg-content code { background: #e2e8f0; padding: 1px 5px; border-radius: 4px; font-size: 0.875em; }
    .msg-content pre { background: #1e293b; color: #e2e8f0; padding: 12px; border-radius: 8px; overflow-x: auto; margin: 8px 0; }
    .msg-content pre code { background: none; padding: 0; color: inherit; }
    .msg-body-scroll { max-height: 480px; overflow-y: auto; padding-right: 4px; }
    .rich-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; margin: 6px 0; }
    .rich-table th, .rich-table td { border: 1px solid #cbd5e1; padding: 4px 8px; text-align: left; }
    .rich-table th { background: #f1f5f9; font-weight: 600; }
    .rich-label { font-size: 0.7rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-top: 8px; margin-bottom: 2px; }
    .rich-json { background: #1e293b; color: #a5f3fc; padding: 10px; border-radius: 8px; font-size: 0.8rem; overflow-x: auto; white-space: pre-wrap; margin: 4px 0; max-height: 320px; overflow-y: auto; }
    .rich-code { background: #1e293b; color: #e2e8f0; padding: 10px; border-radius: 8px; font-size: 0.8rem; overflow-x: auto; white-space: pre-wrap; margin: 4px 0; max-height: 320px; overflow-y: auto; }
    .params-bar input { font-size: 0.75rem; }
    .code-input { font-family: 'Cascadia Code', 'Fira Code', 'JetBrains Mono', 'Consolas', monospace; font-size: 0.8rem; tab-size: 4; line-height: 1.5; background: #1e293b; color: #e2e8f0; }
    .code-input::placeholder { color: #64748b; }
    .input-label { font-size: 0.7rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px; }
    .msg-actions { display: flex; gap: 6px; margin-top: 6px; opacity: 0; transition: opacity 0.15s; }
    .msg-user:hover .msg-actions, .msg-bot:hover .msg-actions { opacity: 1; }
    .msg-action-btn { font-size: 0.65rem; padding: 2px 7px; border-radius: 4px; border: 1px solid #cbd5e1; background: #fff; color: #64748b; cursor: pointer; transition: background 0.1s, color 0.1s; }
    .msg-action-btn:hover { background: #f1f5f9; color: #1e293b; }
    .msg-action-btn.copied { background: #dcfce7; color: #16a34a; border-color: #86efac; }
    .sample-btn { font-size: 0.72rem; padding: 3px 10px; border-radius: 6px; border: 1px solid #cbd5e1; background: #f8fafc; color: #475569; cursor: pointer; white-space: nowrap; transition: background 0.1s, border-color 0.1s; }
    .sample-btn:hover { background: {{ cfg.theme.primary_color }}15; border-color: {{ cfg.theme.primary_color }}; color: {{ cfg.theme.primary_color }}; }
</style>
{% endblock %}
{% block body %}
<div class="fixed inset-0 flex flex-col" style="background-color: {{ cfg.theme.background_color }}">
    <!-- Top bar -->
    <header class="flex-shrink-0 border-b border-slate-200 bg-white">
        <div class="max-w-5xl mx-auto px-4 h-14 flex items-center justify-between">
            <div class="flex items-center gap-3">
                {% if cfg.theme.logo_url %}
                <img src="{{ cfg.theme.logo_url }}" alt="" class="h-7">
                {% else %}
                <div class="w-8 h-8 rounded-lg brand-gradient flex items-center justify-center">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                    </svg>
                </div>
                {% endif %}
                <h1 class="font-semibold text-sm" style="color: {{ cfg.theme.text_color }}">{{ cfg.name }}</h1>
            </div>
            <div class="flex items-center gap-4">
                {% if show_endpoint_selector and endpoints|length > 1 %}
                <select id="endpoint-select"
                        class="text-xs border border-slate-300 rounded-lg px-2 py-1.5 focus:outline-none focus:border-brand-primary">
                    {% for ep in endpoints %}
                    <option value="{{ ep }}">{{ ep }}</option>
                    {% endfor %}
                </select>
                {% endif %}
                {% if param_configs %}
                <button onclick="document.getElementById('params-panel').classList.toggle('hidden')"
                        class="text-xs border border-slate-300 rounded-lg px-2 py-1.5 hover:bg-slate-50 transition-colors"
                        title="Parameters">
                    &#9881; Params
                </button>
                {% endif %}
                <span class="text-xs text-slate-500">{{ username }}</span>
                <a href="{{ logout_url }}"
                   class="text-xs text-slate-400 hover:text-red-500 transition-colors flex items-center gap-1">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                    </svg>
                    Logout
                </a>
            </div>
        </div>
    </header>

    <!-- Missing required params error banner -->
    {% if missing_params_error %}
    <div id="missing-params-banner" class="flex-shrink-0 border-b border-red-200 bg-red-50">
        <div class="max-w-5xl mx-auto px-4 py-2 flex items-center gap-2 text-red-700 text-xs">
            <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <span>{{ missing_params_error }}. Use the <strong>&#9881; Params</strong> panel to set them before sending messages.</span>
        </div>
    </div>
    {% endif %}

    <!-- Params panel -->
    {% if param_configs %}
    <div id="params-panel" class="{% if not missing_params_error %}hidden {% endif %}flex-shrink-0 border-b border-slate-200 bg-slate-50 params-bar">
        <div class="max-w-5xl mx-auto px-4 py-2 flex flex-wrap items-center gap-3">
            {% for p in param_configs %}
            <div class="flex items-center gap-1.5">
                <label class="text-xs font-medium {% if p.default is none and not params.get(p.name) %}text-red-500{% else %}text-slate-500{% endif %}">
                    {{ p.label or p.name }}{% if p.default is none %}<span title="Required"> *</span>{% endif %}:
                </label>
                <input type="text" data-param="{{ p.name }}" value="{{ params.get(p.name, '') }}"
                       class="px-2 py-1 rounded border w-32 focus:outline-none focus:border-amber-500
                              {% if p.default is none and not params.get(p.name) %}border-red-400 bg-red-50{% else %}border-slate-300{% endif %}">
            </div>
            {% endfor %}
            <button onclick="applyParams()"
                    class="text-xs px-3 py-1 rounded-lg bg-amber-500 text-white font-medium hover:bg-amber-600 transition-colors">Apply</button>
        </div>
    </div>
    {% endif %}

    <!-- Messages area -->
    <div id="messages" class="flex-1 overflow-y-auto">
        <div class="max-w-3xl mx-auto px-4 py-6 space-y-4" id="msg-container">
            <!-- Welcome message -->
            <div class="msg-bot rounded-lg p-4">
                <div class="flex items-start gap-3">
                    <div class="w-7 h-7 rounded-full bg-slate-300 flex items-center justify-center flex-shrink-0 mt-0.5">
                        <svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 014.5 0m0 0v5.714a2.25 2.25 0 00.659 1.591L19 14.5M14.25 3.104c.251.023.501.05.75.082M19 14.5l-2.47 2.47"/>
                        </svg>
                    </div>
                    <div class="msg-content text-sm text-slate-700">{{ cfg.chat.welcome_message }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Samples panel -->
    {% if cfg.chat.samples %}
    <div id="samples-panel" class="flex-shrink-0 border-t border-slate-200 bg-white">
        <div class="max-w-3xl mx-auto px-4 py-2">
            <details>
                <summary class="flex items-center gap-2 text-xs font-medium text-slate-500 hover:text-slate-700 select-none py-1">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    Sample Requests ({{ cfg.chat.samples|length }})
                </summary>
                <div class="flex flex-wrap gap-2 pt-2 pb-1">
                    {% for s in cfg.chat.samples %}
                    <button type="button" class="sample-btn"
                            data-message="{{ s.message | e }}"
                            data-endpoint="{{ s.endpoint | e }}"
                            onclick="loadSample(this)">{{ s.label | e }}</button>
                    {% endfor %}
                </div>
            </details>
        </div>
    </div>
    {% endif %}

    <!-- Input area -->
    <div class="flex-shrink-0 border-t border-slate-200 bg-white">
        <div class="max-w-3xl mx-auto px-4 py-4">
            {% if cfg.chat.input.label %}
            <div class="input-label">{{ cfg.chat.input.label }}</div>
            {% endif %}
            <form id="chat-form" class="flex items-end gap-3">
                {% if cfg.chat.input.type == 'code' %}
                <textarea id="chat-input" rows="{{ cfg.chat.input.rows }}"
                          class="code-input flex-1 resize-none rounded-xl border border-slate-600 px-4 py-3
                                 focus:outline-none focus:border-blue-500 transition-colors"
                          placeholder="{{ cfg.chat.placeholder }}"
                          spellcheck="false"
                          data-mode="code"
                          data-max-rows="{{ cfg.chat.input.max_rows }}"
                          data-submit-enter="{{ cfg.chat.input.submit_on_enter | lower }}"></textarea>
                {% elif cfg.chat.input.type == 'multiline' %}
                <textarea id="chat-input" rows="{{ cfg.chat.input.rows }}"
                          class="flex-1 resize-none rounded-xl border border-slate-300 px-4 py-2.5 text-sm
                                 focus:outline-none focus:border-brand-primary transition-colors"
                          placeholder="{{ cfg.chat.placeholder }}"
                          data-mode="multiline"
                          data-max-rows="{{ cfg.chat.input.max_rows }}"
                          data-submit-enter="{{ cfg.chat.input.submit_on_enter | lower }}"></textarea>
                {% else %}
                <textarea id="chat-input" rows="1"
                          class="flex-1 resize-none rounded-xl border border-slate-300 px-4 py-2.5 text-sm
                                 focus:outline-none focus:border-brand-primary transition-colors"
                          placeholder="{{ cfg.chat.placeholder }}"
                          data-mode="text"
                          data-max-rows="{{ cfg.chat.input.max_rows }}"
                          data-submit-enter="true"></textarea>
                {% endif %}
                <button type="submit" id="send-btn"
                        class="flex-shrink-0 w-10 h-10 rounded-xl brand-gradient text-white flex items-center justify-center
                               hover:opacity-90 transition-opacity disabled:opacity-50"
                        title="Send ({{ 'Ctrl+Enter' if not cfg.chat.input.submit_on_enter else 'Enter' }})">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19V5m0 0l-7 7m7-7l7 7" transform="rotate(45 12 12)"/>
                    </svg>
                </button>
            </form>
            {% if cfg.chat.input.type in ('code', 'multiline') and not cfg.chat.input.submit_on_enter %}
            <div class="text-xs text-slate-400 mt-1 text-right">Ctrl+Enter to send</div>
            {% endif %}
        </div>
    </div>
</div>

<script>
const CHAT_BASE = '{{ chat_url | safe }}'.split('?')[0];
const CHAT_SEND_BASE = '{{ chat_send_url | safe }}'.split('?')[0];
const form = document.getElementById('chat-form');
const input = document.getElementById('chat-input');
const container = document.getElementById('msg-container');
const messagesDiv = document.getElementById('messages');
const sendBtn = document.getElementById('send-btn');
const EP_DISPLAY = {{ ep_display_json | safe }};
const SAMPLES = {{ samples_json | safe }};
const INPUT_MODE = input.dataset.mode || 'text';
const SUBMIT_ENTER = input.dataset.submitEnter === 'true';
const MAX_ROWS = parseInt(input.dataset.maxRows || '6');

// Auto-resize textarea
function autoResize() {
    input.style.height = 'auto';
    const lineHeight = parseInt(getComputedStyle(input).lineHeight) || 20;
    const maxHeight = lineHeight * MAX_ROWS;
    input.style.height = Math.min(input.scrollHeight, maxHeight) + 'px';
}
input.addEventListener('input', autoResize);

// Tab key support for code mode
if (INPUT_MODE === 'code') {
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Tab') {
            e.preventDefault();
            const start = this.selectionStart;
            const end = this.selectionEnd;
            this.value = this.value.substring(0, start) + '    ' + this.value.substring(end);
            this.selectionStart = this.selectionEnd = start + 4;
        }
    });
}

// Submit behavior
input.addEventListener('keydown', function(e) {
    if (SUBMIT_ENTER) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            form.requestSubmit();
        }
    } else {
        if (e.key === 'Enter' && e.ctrlKey) {
            e.preventDefault();
            form.requestSubmit();
        }
    }
});

function loadSample(btn) {
    input.value = btn.dataset.message || '';
    autoResize();
    const epSelect = document.getElementById('endpoint-select');
    if (epSelect && btn.dataset.endpoint) {
        const opt = Array.from(epSelect.options).find(o => o.value === btn.dataset.endpoint);
        if (opt) epSelect.value = btn.dataset.endpoint;
    }
    input.focus();
}

function copyText(text, btn) {
    navigator.clipboard.writeText(text).then(() => {
        btn.textContent = 'Copied!';
        btn.classList.add('copied');
        setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 1500);
    }).catch(() => {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed'; ta.style.opacity = '0';
        document.body.appendChild(ta); ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        btn.textContent = 'Copied!';
        btn.classList.add('copied');
        setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 1500);
    });
}

function applyParams() {
    const inputs = document.querySelectorAll('[data-param]');
    const qs = new URLSearchParams(window.location.search);
    inputs.forEach(inp => qs.set(inp.dataset.param, inp.value));
    window.location.href = `${CHAT_BASE}?${qs.toString()}`;
}

function escapeHtml(text) {
    const d = document.createElement('div');
    d.textContent = text;
    return d.innerHTML;
}

function formatMessage(text) {
    // Basic markdown-like formatting
    let html = escapeHtml(text);
    // Code blocks
    html = html.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
    html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
    // Bold
    html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    // Line breaks
    html = html.replace(/\n/g, '<br>');
    return html;
}

function renderRichValue(item) {
    const val = item.value;
    const t = item.type;
    let html = `<div class="rich-label">${escapeHtml(item.label)}</div>`;
    if (t === 'table' && typeof val === 'object') {
        html += renderTable(val);
    } else if (t === 'json') {
        html += `<div class="rich-json">${escapeHtml(typeof val === 'string' ? val : JSON.stringify(val, null, 2))}</div>`;
    } else if (t === 'code') {
        html += `<div class="rich-code">${escapeHtml(typeof val === 'string' ? val : JSON.stringify(val, null, 2))}</div>`;
    } else if (t === 'markdown' || t === 'text') {
        html += `<div class="text-sm text-slate-700">${formatMessage(String(val))}</div>`;
    } else {
        html += `<div class="text-sm text-slate-700">${formatMessage(String(val))}</div>`;
    }
    return html;
}

function renderTable(val) {
    // Array of objects → table
    if (Array.isArray(val) && val.length > 0 && typeof val[0] === 'object') {
        const keys = Object.keys(val[0]);
        let h = '<table class="rich-table"><thead><tr>' + keys.map(k => `<th>${escapeHtml(k)}</th>`).join('') + '</tr></thead><tbody>';
        val.forEach(row => { h += '<tr>' + keys.map(k => `<td>${escapeHtml(String(row[k] ?? ''))}</td>`).join('') + '</tr>'; });
        h += '</tbody></table>';
        return h;
    }
    // Object → key-value table
    if (typeof val === 'object' && !Array.isArray(val)) {
        let h = '<table class="rich-table"><tbody>';
        Object.entries(val).forEach(([k, v]) => { h += `<tr><th>${escapeHtml(k)}</th><td>${escapeHtml(String(v))}</td></tr>`; });
        h += '</tbody></table>';
        return h;
    }
    return `<div class="text-sm">${escapeHtml(String(val))}</div>`;
}

function addMessage(text, isUser, displayItems) {
    const div = document.createElement('div');
    div.className = isUser ? 'msg-user rounded-lg p-4' : 'msg-bot rounded-lg p-4';

    const icon = isUser
        ? `<svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>`
        : `<svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 014.5 0m0 0v5.714a2.25 2.25 0 00.659 1.591L19 14.5M14.25 3.104c.251.023.501.05.75.082M19 14.5l-2.47 2.47"/></svg>`;

    const iconBg = isUser ? 'brand-gradient' : 'bg-slate-300';

    let contentHtml = formatMessage(text);
    if (displayItems && displayItems.length > 0) {
        contentHtml = displayItems.map(item => renderRichValue(item)).join('');
    }

    // Action buttons
    let actionsHtml = '<div class="msg-actions">';
    if (isUser) {
        actionsHtml += `<button class="msg-action-btn" onclick="editMessage(this)" title="Load into input">Edit &amp; Resubmit</button>`;
    }
    actionsHtml += `<button class="msg-action-btn" onclick="copyText(this.closest('.msg-user,.msg-bot').dataset.rawText, this)">Copy</button>`;
    actionsHtml += '</div>';

    div.dataset.rawText = text;
    div.innerHTML = `
        <div class="flex items-start gap-3">
            <div class="w-7 h-7 rounded-full ${iconBg} flex items-center justify-center flex-shrink-0 mt-0.5">${icon}</div>
            <div class="w-full">
                <div class="msg-body-scroll msg-content text-sm ${isUser ? '' : 'text-slate-700'}">${contentHtml}</div>
                ${actionsHtml}
            </div>
        </div>`;
    container.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    return div;
}

function editMessage(btn) {
    const msgDiv = btn.closest('.msg-user,.msg-bot');
    const text = msgDiv ? msgDiv.dataset.rawText : '';
    if (!text) return;
    input.value = text;
    autoResize();
    input.focus();
    input.scrollTop = input.scrollHeight;
}

function showTyping() {
    const div = document.createElement('div');
    div.id = 'typing';
    div.className = 'msg-bot rounded-lg p-4';
    div.innerHTML = `
        <div class="flex items-start gap-3">
            <div class="w-7 h-7 rounded-full bg-slate-300 flex items-center justify-center flex-shrink-0">
                <svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 014.5 0m0 0v5.714a2.25 2.25 0 00.659 1.591L19 14.5M14.25 3.104c.251.023.501.05.75.082M19 14.5l-2.47 2.47"/></svg>
            </div>
            <div class="flex gap-1 py-2">
                <span class="typing-dot w-2 h-2 rounded-full bg-slate-400"></span>
                <span class="typing-dot w-2 h-2 rounded-full bg-slate-400"></span>
                <span class="typing-dot w-2 h-2 rounded-full bg-slate-400"></span>
            </div>
        </div>`;
    container.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function removeTyping() {
    const el = document.getElementById('typing');
    if (el) el.remove();
}

form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const msg = input.value.trim();
    if (!msg) return;

    addMessage(msg, true);
    input.value = '';
    autoResize();
    sendBtn.disabled = true;
    showTyping();

    const epSelect = document.getElementById('endpoint-select');
    const endpoint = epSelect ? epSelect.value : 'default';

    try {
        const resp = await fetch(CHAT_SEND_BASE + window.location.search, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: msg, endpoint: endpoint }),
        });
        const data = await resp.json();
        removeTyping();
        addMessage(data.response || 'No response received.', false, data.display || null);
    } catch (err) {
        removeTyping();
        addMessage('Error: Could not reach the server.', false);
    } finally {
        sendBtn.disabled = false;
        input.focus();
    }
});

input.focus();
</script>
{% endblock %}
